#' Load embeddings generated by the \link{pkgsimil_embeddings_from_pkgs}
#' function, either for all rOpenSci packages or, if `fns = TRUE`,  all
#' individual functions within those packages.
#'
#' @inheritParams pkgsimil_similar_pkgs
#' @param fns If `FALSE` (default), load embeddings for all rOpenSci packages;
#' otherwise load (considerably larger dataset of) embeddings for all
#' individual functions.
#' @param what Either "embeddings" to load pre-generated embeddings, or "idfs"
#' to load pre-generated Inverse Document Frequency weightings.
#' @return The loaded `data.frame`.
#' @export
#'
#' @examples
#' \dontrun{
#' embeddings <- pkgsimil_load_data ("embeddings")
#' embeddings_fns <- pkgsimil_load_data ("embeddings", fns = TRUE)
#' idfs <- pkgsimil_load_data ("idfs")
#' idfs_fns <- pkgsimil_load_data ("idfs", fns = TRUE)
#' }
pkgsimil_load_data <- function (what = "embeddings", corpus = "ropensci", fns = FALSE) {

    corpus <- match.arg (corpus, c ("ropensci", "cran"))
    what <- match.arg (what, c ("embeddings", "idfs"))

    if (corpus == "ropensci") {

        if (what == "embeddings") {
            fname <- ifelse (fns, "embeddings-fns.Rds", "embeddings.Rds")
        } else {
            fname <- ifelse (fns, "bm25-ropensci-fns.Rds", "bm25-ropensci.Rds")
        }

    } else if (corpus == "cran") {

        if (what == "embeddings") {
            fname <- "embeddings-cran.Rds"
        } else {
            fname <- "bm25-cran.Rds"
        }
    }

    fname <- fs::path (pkgsimil_cache_path (), fname)
    if (!fs::file_exists (fname)) {
        fname <- pkgsimil_dl_data (what = what, corpus = corpus, fns = fns)
    }
    readRDS (fname)
}

pkgsimil_dl_data <- function (what = "embeddings", corpus = "ropensci", fns = FALSE) {

    what <- match.arg (what, c ("embeddings", "idfs"))
    corpus <- match.arg (corpus, c ("ropensci", "cran"))

    url_base <-
        "https://github.com/ropensci-review-tools/pkgsimil/releases/download/"
    version <- "v0.1.2"

    if (corpus == "ropensci") {
        if (what == "embeddings") {
            file <- ifelse (fns, "embeddings-fns.Rds", "embeddings.Rds")
        } else {
            file <- ifelse (fns, "bm25-ropensci-fns.Rds", "bm25-ropensci.Rds")
        }
    } else if (corpus == "cran") {
        if (what == "embeddings") {
            file <- "embeddings-cran.Rds"
        } else {
            file <- "bm25-cran.Rds"
        }
    }

    dl_url <- paste0 (url_base, version, "/", file)

    destfile <- fs::path (pkgsimil_cache_path (), file)
    curl::curl_download (url = dl_url, destfile = destfile, quiet = opt_is_quiet ())
    return (destfile)
}

pkgsimil_cache_path <- function () {

    cache_dir <- Sys.getenv ("PKGSIMIL_CACHE_DIR")

    if (cache_dir == "") {
        cache_dir <- fs::path_expand (fs::path (
            rappdirs::user_cache_dir (),
            "R",
            "pkgsimil"
        ))
        if (!fs::dir_exists (cache_dir)) {
            fs::dir_create (cache_dir, recurse = TRUE)
        }
    }

    return (cache_dir)
}
